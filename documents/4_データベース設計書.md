# データベース設計書

## 概要
本ドキュメントは、MonsterWalker（dqwfunモンスターウォーカー）で使用するSupabase PostgreSQLデータベースのスキーマ設計を記載しています。ドラクエウォークのモンスター攻略情報を登録・共有するために必要なテーブル構成を定義しています。

---

## データベース構成概要

### 使用データベース
- **Supabase PostgreSQL**: マネージドPostgreSQLデータベース
- **認証**: Supabase Auth（auth.usersテーブル）を使用
- **セキュリティ**: Row Level Security (RLS) を使用
- **ストレージ**: Supabase Storage（スクリーンショット画像保存）

### Supabaseプロジェクト共用
本アプリはdqwfuntool内でSupabaseプロジェクトを共用する。以下のテーブルは他アプリと共通で使用する。

| 共用テーブル | 説明 |
|-------------|------|
| users | ユーザー認証情報（auth.users） |
| profiles | プロフィール情報（ニックネーム、アイコン、X公開設定） |
| ng_words | NGワードリスト |

これにより、同一アカウントで複数アプリへのシングルサインオンが可能となる。

### テーブル命名規則
- **共用テーブル**: プレフィクスなし（users, profiles, ng_words）
- **本アプリ専用マスタテーブル**: `mw_mst_` プレフィクス
- **本アプリ専用トランザクションテーブル**: `mw_` プレフィクス

---

## テーブル一覧

| テーブル名 | スキーマ | 用途 | 備考 |
|-----------|---------|------|------|
| users | auth | ユーザー認証情報 | Supabase Auth（共用） |
| profiles | public | プロフィール情報 | 共用 |
| ng_words | public | NGワードリスト | 共用 |
| mw_mst_monsters | public | モンスターマスタ | 本アプリ専用 |
| mw_mst_weapons | public | 武器マスタ | 本アプリ専用 |
| mw_mst_jobs | public | 職業マスタ | 本アプリ専用 |
| mw_strategies | public | 攻略情報 | 本アプリ専用 |
| mw_strategy_members | public | パーティメンバー情報 | 本アプリ専用 |
| mw_likes | public | いいね | 本アプリ専用 |
| mw_favorites_strategies | public | 攻略情報お気に入り | 本アプリ専用 |
| mw_favorites_searches | public | 検索条件お気に入り | 本アプリ専用 |
| mw_reports | public | 通報 | 本アプリ専用 |
| mw_requests | public | 要望 | 本アプリ専用 |

---

## 詳細テーブル定義

### 1. auth.users (Supabase Auth標準テーブル)

**用途**: ユーザー認証情報を管理する標準テーブル。Supabase Authにより自動的に管理される。

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PK | ユーザーID（UUID v4） |
| email | varchar | UNIQUE, NOT NULL | メールアドレス |
| encrypted_password | varchar | NOT NULL | 暗号化されたパスワード（bcrypt） |
| email_confirmed_at | timestamptz | NULL | メール認証完了日時 |
| created_at | timestamptz | NOT NULL, DEFAULT now() | アカウント作成日時 |
| updated_at | timestamptz | NOT NULL, DEFAULT now() | 最終更新日時 |
| last_sign_in_at | timestamptz | NULL | 最終ログイン日時 |

**特徴**:
- Supabase Authにより自動管理
- パスワードは自動的にbcryptでハッシュ化
- JWT認証トークンの発行に使用
- メール認証、X（旧Twitter）OAuth認証をサポート

**RLS**: Supabase Authが自動管理

**DDL**: Supabase Authにより自動作成されるため不要

---

### 2. public.profiles (共用テーブル)

**用途**: ユーザーのプロフィール情報を保存。dqwfuntool内の複数アプリで共用。

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| user_id | uuid | PK, FK → auth.users(id) ON DELETE CASCADE | ユーザーID |
| nickname | varchar(50) | NOT NULL | ニックネーム |
| avatar_url | text | NULL | アイコン画像URL |
| x_account_public | boolean | NOT NULL, DEFAULT false | Xアカウント公開設定（オプトイン） |
| created_at | timestamptz | NOT NULL, DEFAULT now() | 作成日時 |
| updated_at | timestamptz | NOT NULL, DEFAULT now() | 更新日時 |

**Xアカウント連携の仕様**:
- **Xアカウント名はprofilesテーブルに保存しない**（セキュリティ上の理由）
- Xアカウント名は`auth.users.raw_user_meta_data`に保存される（Supabase Auth標準）
- `x_account_public`: X連携済みの場合のみ公開設定が可能（オプトイン方式）
- X未連携の場合: `x_account_public` = false
- X連携解除時: `x_account_public` = false にリセット

**Xアカウント名の取得方式**:
- profilesテーブルはanon keyでアクセス可能なため、Xアカウント名を保存するとスクレイピングリスクがある
- Xアカウント名は`auth.users.raw_user_meta_data`に保存され、anon keyではアクセス不可
- 公開設定ONの場合のみ、Edge Function経由でXアカウント名を取得・表示する

**RLS**:
- SELECT: 全員許可
- INSERT: 認証済みユーザーが自分のIDでのみ登録可
- UPDATE: 自分のデータのみ更新可
- DELETE: 不可（ユーザー削除時にCASCADE）

**DDL**:
```sql
CREATE TABLE profiles (
  user_id uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE, -- ユーザーID
  nickname varchar(50) NOT NULL,                                        -- ニックネーム
  avatar_url text NULL,                                                 -- アイコン画像URL
  x_account_public boolean NOT NULL DEFAULT false,                      -- Xアカウント公開設定（オプトイン）
  created_at timestamptz NOT NULL DEFAULT now(),                        -- 作成日時
  updated_at timestamptz NOT NULL DEFAULT now()                         -- 更新日時
);

ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Profiles are viewable by everyone" ON profiles FOR SELECT USING (true);
CREATE POLICY "Users can insert their own profile" ON profiles FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update their own profile" ON profiles FOR UPDATE USING (auth.uid() = user_id);
```

---

### 3. public.ng_words (共用テーブル)

**用途**: NGワードリストを保存。管理アプリからメンテナンス。

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| ng_word_no | bigint | PK, GENERATED ALWAYS AS IDENTITY | NGワード番号 |
| word | varchar(100) | NOT NULL, UNIQUE | NGワード |
| created_at | timestamptz | NOT NULL, DEFAULT now() | 登録日時 |

**RLS**:
- SELECT: 全員許可
- INSERT/UPDATE/DELETE: 不可（管理アプリからのみ）

**DDL**:
```sql
CREATE TABLE ng_words (
  ng_word_no bigint PRIMARY KEY GENERATED ALWAYS AS IDENTITY, -- NGワード番号
  word varchar(100) NOT NULL UNIQUE,                          -- NGワード
  created_at timestamptz NOT NULL DEFAULT now()               -- 登録日時
);

ALTER TABLE ng_words ENABLE ROW LEVEL SECURITY;
CREATE POLICY "NG words are viewable by everyone" ON ng_words FOR SELECT USING (true);
```

---

### 4. public.mw_mst_monsters (マスタテーブル)

**用途**: モンスターマスタ情報。管理アプリからメンテナンス。

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| monster_no | bigint | PK, GENERATED ALWAYS AS IDENTITY | モンスター番号 |
| monster_category | monster_category_enum | NOT NULL | カテゴリー（hokora/megamon/gigamon） |
| monster_name | varchar(100) | NOT NULL, UNIQUE(category, name) | モンスター名 |
| star_rank | int | NOT NULL, CHECK (1-5) | 星ランク（1〜5） |
| release_date | date | NULL | 登場年月 |
| sort_order | int | NOT NULL, DEFAULT 0 | 表示順 |
| is_active | boolean | NOT NULL, DEFAULT true | 有効フラグ |
| created_at | timestamptz | NOT NULL, DEFAULT now() | 登録日時 |
| updated_at | timestamptz | NOT NULL, DEFAULT now() | 更新日時 |

**モンスターカテゴリー**:
- `hokora`: ほこら
- `megamon`: メガモン
- `gigamon`: ギガモン

**RLS**:
- SELECT: 全員許可
- INSERT/UPDATE/DELETE: 不可（管理アプリからのみ）

**DDL**:
```sql
CREATE TYPE monster_category_enum AS ENUM ('hokora', 'megamon', 'gigamon');

CREATE TABLE mw_mst_monsters (
  monster_no bigint PRIMARY KEY GENERATED ALWAYS AS IDENTITY,   -- モンスター番号
  monster_category monster_category_enum NOT NULL,              -- カテゴリー（hokora/megamon/gigamon）
  monster_name varchar(100) NOT NULL,                           -- モンスター名
  star_rank int NOT NULL,                                       -- 星ランク（1〜5）
  release_date date,                                            -- 登場年月
  sort_order int NOT NULL DEFAULT 0,                            -- 表示順
  is_active boolean NOT NULL DEFAULT true,                      -- 有効フラグ
  created_at timestamptz NOT NULL DEFAULT now(),                -- 登録日時
  updated_at timestamptz NOT NULL DEFAULT now(),                -- 更新日時
  CONSTRAINT check_monster_star_rank CHECK (star_rank >= 1 AND star_rank <= 5),
  CONSTRAINT unique_category_monster_name UNIQUE (monster_category, monster_name)
);

CREATE INDEX idx_mw_mst_monsters_sort ON mw_mst_monsters (sort_order);
CREATE INDEX idx_mw_mst_monsters_star_rank ON mw_mst_monsters (star_rank);
CREATE INDEX idx_mw_mst_monsters_category ON mw_mst_monsters (monster_category);

ALTER TABLE mw_mst_monsters ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Monsters are viewable by everyone" ON mw_mst_monsters FOR SELECT USING (true);
```

---

### 5. public.mw_mst_weapons (マスタテーブル)

**用途**: 武器マスタ情報。管理アプリからメンテナンス。

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| weapon_no | bigint | PK, GENERATED ALWAYS AS IDENTITY | 武器番号 |
| weapon_name | varchar(100) | NOT NULL, UNIQUE | 武器名 |
| star_rank | int | NOT NULL, CHECK (1-5) | 星ランク（1〜5） |
| release_date | date | NULL | 登場年月 |
| sort_order | int | NOT NULL, DEFAULT 0 | 表示順 |
| is_active | boolean | NOT NULL, DEFAULT true | 有効フラグ |
| created_at | timestamptz | NOT NULL, DEFAULT now() | 登録日時 |
| updated_at | timestamptz | NOT NULL, DEFAULT now() | 更新日時 |

**RLS**:
- SELECT: 全員許可
- INSERT/UPDATE/DELETE: 不可（管理アプリからのみ）

**DDL**:
```sql
CREATE TABLE mw_mst_weapons (
  weapon_no bigint PRIMARY KEY GENERATED ALWAYS AS IDENTITY,   -- 武器番号
  weapon_name varchar(100) NOT NULL UNIQUE,                    -- 武器名
  star_rank int NOT NULL,                                      -- 星ランク（1〜5）
  release_date date,                                           -- 登場年月
  sort_order int NOT NULL DEFAULT 0,                           -- 表示順
  is_active boolean NOT NULL DEFAULT true,                     -- 有効フラグ
  created_at timestamptz NOT NULL DEFAULT now(),               -- 登録日時
  updated_at timestamptz NOT NULL DEFAULT now(),               -- 更新日時
  CONSTRAINT check_star_rank CHECK (star_rank >= 1 AND star_rank <= 5)
);

CREATE INDEX idx_mw_mst_weapons_sort ON mw_mst_weapons (sort_order);
CREATE INDEX idx_mw_mst_weapons_star_rank ON mw_mst_weapons (star_rank);

ALTER TABLE mw_mst_weapons ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Weapons are viewable by everyone" ON mw_mst_weapons FOR SELECT USING (true);
```

---

### 6. public.mw_mst_jobs (マスタテーブル)

**用途**: 職業マスタ情報。管理アプリからメンテナンス。

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| job_no | bigint | PK, GENERATED ALWAYS AS IDENTITY | 職業番号 |
| job_name | varchar(100) | NOT NULL, UNIQUE | 職業名 |
| job_rank | job_rank_enum | NOT NULL | 職業ランク（basic/advanced/special） |
| sort_order | int | NOT NULL, DEFAULT 0 | 表示順 |
| is_active | boolean | NOT NULL, DEFAULT true | 有効フラグ |
| created_at | timestamptz | NOT NULL, DEFAULT now() | 登録日時 |
| updated_at | timestamptz | NOT NULL, DEFAULT now() | 更新日時 |

**職業ランク**:
- `basic`: 基本職
- `advanced`: 上級職
- `special`: 特級職

**RLS**:
- SELECT: 全員許可
- INSERT/UPDATE/DELETE: 不可（管理アプリからのみ）

**DDL**:
```sql
CREATE TYPE job_rank_enum AS ENUM ('basic', 'advanced', 'special');

CREATE TABLE mw_mst_jobs (
  job_no bigint PRIMARY KEY GENERATED ALWAYS AS IDENTITY,   -- 職業番号
  job_name varchar(100) NOT NULL UNIQUE,                    -- 職業名
  job_rank job_rank_enum NOT NULL,                          -- 職業ランク（basic/advanced/special）
  sort_order int NOT NULL DEFAULT 0,                        -- 表示順
  is_active boolean NOT NULL DEFAULT true,                  -- 有効フラグ
  created_at timestamptz NOT NULL DEFAULT now(),            -- 登録日時
  updated_at timestamptz NOT NULL DEFAULT now()             -- 更新日時
);

CREATE INDEX idx_mw_mst_jobs_sort ON mw_mst_jobs (sort_order);
CREATE INDEX idx_mw_mst_jobs_rank ON mw_mst_jobs (job_rank);

ALTER TABLE mw_mst_jobs ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Jobs are viewable by everyone" ON mw_mst_jobs FOR SELECT USING (true);
```

---

### 7. public.mw_strategies (トランザクションテーブル)

**用途**: モンスター攻略情報を保存。

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| strategy_no | bigint | PK, GENERATED ALWAYS AS IDENTITY | 攻略情報番号 |
| user_id | uuid | NOT NULL, FK → auth.users(id) ON DELETE CASCADE | 登録ユーザーID |
| monster_no | bigint | NOT NULL, FK → mw_mst_monsters(monster_no) | 攻略対象モンスター番号 |
| strategy_type | strategy_type_enum | NOT NULL | 攻略タイプ（oneshot/semiauto/auto） |
| action_description | text | NULL | 行動順序・内容（NULL=未入力） |
| like_count | int | NOT NULL, DEFAULT 0 | いいね数（集計用キャッシュ） |
| is_deleted | boolean | NOT NULL, DEFAULT false | 削除フラグ |
| deleted_at | timestamptz | NULL | 削除日時 |
| created_at | timestamptz | NOT NULL, DEFAULT now() | 登録日時 |
| updated_at | timestamptz | NOT NULL, DEFAULT now() | 更新日時 |

**攻略タイプ**:
- `oneshot`: ワンパン
- `semiauto`: セミオート
- `auto`: オート

**RLS**:
- SELECT: 全員許可（is_deleted = falseのみ）
- INSERT: 認証済みユーザーが自分のuser_idでのみ登録可
- UPDATE: 自分のデータのみ更新可
- DELETE: 自分のデータのみ削除可（論理削除推奨）

**DDL**:
```sql
CREATE TYPE strategy_type_enum AS ENUM ('oneshot', 'semiauto', 'auto');

CREATE TABLE mw_strategies (
  strategy_no bigint PRIMARY KEY GENERATED ALWAYS AS IDENTITY,                 -- 攻略情報番号
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,           -- 登録ユーザーID
  monster_no bigint NOT NULL REFERENCES mw_mst_monsters(monster_no),           -- 攻略対象モンスター番号
  strategy_type strategy_type_enum NOT NULL,                                   -- 攻略タイプ（oneshot/semiauto/auto）
  action_description text NULL,                                                -- 行動順序・内容（NULL=未入力）
  like_count int NOT NULL DEFAULT 0,                                           -- いいね数（集計用キャッシュ）
  is_deleted boolean NOT NULL DEFAULT false,                                   -- 削除フラグ
  deleted_at timestamptz NULL,                                                 -- 削除日時
  created_at timestamptz NOT NULL DEFAULT now(),                               -- 登録日時
  updated_at timestamptz NOT NULL DEFAULT now()                                -- 更新日時
);

CREATE INDEX idx_mw_strategies_user_id ON mw_strategies (user_id);
CREATE INDEX idx_mw_strategies_monster_no ON mw_strategies (monster_no);
CREATE INDEX idx_mw_strategies_like_count ON mw_strategies (like_count DESC);
CREATE INDEX idx_mw_strategies_is_deleted ON mw_strategies (is_deleted);
CREATE INDEX idx_mw_strategies_created_at ON mw_strategies (created_at DESC);

ALTER TABLE mw_strategies ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Strategies are viewable by everyone" ON mw_strategies FOR SELECT USING (is_deleted = false);
CREATE POLICY "Users can insert their own strategies" ON mw_strategies FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update their own strategies" ON mw_strategies FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete their own strategies" ON mw_strategies FOR DELETE USING (auth.uid() = user_id);
```

---

### 8. public.mw_strategy_members (トランザクションテーブル)

**用途**: 攻略情報のパーティメンバー情報（4人分）を保存。

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| member_no | bigint | PK, GENERATED ALWAYS AS IDENTITY | メンバー番号 |
| strategy_no | bigint | NOT NULL, FK → mw_strategies(strategy_no) ON DELETE CASCADE | 攻略情報番号 |
| member_order | int | NOT NULL | メンバー順番（1〜4） |
| weapon_no | bigint | NULL, FK → mw_mst_weapons(weapon_no) | 武器番号（NULL=任意） |
| job_no | bigint | NULL, FK → mw_mst_jobs(job_no) | 職業番号（NULL=任意） |
| screenshot_front_url | text | NULL | スクリーンショット（表）URL（NULL=未登録） |
| screenshot_back_url | text | NULL | スクリーンショット（裏）URL（NULL=未登録） |
| created_at | timestamptz | NOT NULL, DEFAULT now() | 登録日時 |
| updated_at | timestamptz | NOT NULL, DEFAULT now() | 更新日時 |

**RLS**: mw_strategiesに従属（親テーブルのRLSに従う）

**DDL**:
```sql
CREATE TABLE mw_strategy_members (
  member_no bigint PRIMARY KEY GENERATED ALWAYS AS IDENTITY,                          -- メンバー番号
  strategy_no bigint NOT NULL REFERENCES mw_strategies(strategy_no) ON DELETE CASCADE, -- 攻略情報番号
  member_order int NOT NULL,                                                          -- メンバー順番（1〜4）
  weapon_no bigint NULL REFERENCES mw_mst_weapons(weapon_no),                         -- 武器番号（NULL=任意）
  job_no bigint NULL REFERENCES mw_mst_jobs(job_no),                                  -- 職業番号（NULL=任意）
  screenshot_front_url text NULL,                                                     -- スクリーンショット（表）URL（NULL=未登録）
  screenshot_back_url text NULL,                                                      -- スクリーンショット（裏）URL（NULL=未登録）
  created_at timestamptz NOT NULL DEFAULT now(),                                      -- 登録日時
  updated_at timestamptz NOT NULL DEFAULT now(),                                      -- 更新日時
  CONSTRAINT unique_strategy_member_order UNIQUE (strategy_no, member_order),
  CONSTRAINT check_member_order CHECK (member_order >= 1 AND member_order <= 4)
);

CREATE INDEX idx_mw_strategy_members_strategy_no ON mw_strategy_members (strategy_no);

ALTER TABLE mw_strategy_members ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Strategy members are viewable by everyone" ON mw_strategy_members FOR SELECT USING (true);
CREATE POLICY "Users can insert their own strategy members" ON mw_strategy_members FOR INSERT
  WITH CHECK (EXISTS (SELECT 1 FROM mw_strategies WHERE strategy_no = mw_strategy_members.strategy_no AND user_id = auth.uid()));
CREATE POLICY "Users can update their own strategy members" ON mw_strategy_members FOR UPDATE
  USING (EXISTS (SELECT 1 FROM mw_strategies WHERE strategy_no = mw_strategy_members.strategy_no AND user_id = auth.uid()));
CREATE POLICY "Users can delete their own strategy members" ON mw_strategy_members FOR DELETE
  USING (EXISTS (SELECT 1 FROM mw_strategies WHERE strategy_no = mw_strategy_members.strategy_no AND user_id = auth.uid()));
```

---

### 9. public.mw_likes (トランザクションテーブル)

**用途**: いいね情報を保存。

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| like_no | bigint | PK, GENERATED ALWAYS AS IDENTITY | いいね番号 |
| user_id | uuid | NOT NULL, FK → auth.users(id) ON DELETE CASCADE | ユーザーID |
| strategy_no | bigint | NOT NULL, FK → mw_strategies(strategy_no) ON DELETE CASCADE | 攻略情報番号 |
| created_at | timestamptz | NOT NULL, DEFAULT now() | いいね日時 |

**RLS**:
- SELECT: 全員許可
- INSERT: 認証済みユーザーが自分のuser_idでのみ登録可
- UPDATE: 不可
- DELETE: 自分のいいねのみ削除可

**DDL**:
```sql
CREATE TABLE mw_likes (
  like_no bigint PRIMARY KEY GENERATED ALWAYS AS IDENTITY,                            -- いいね番号
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,                  -- ユーザーID
  strategy_no bigint NOT NULL REFERENCES mw_strategies(strategy_no) ON DELETE CASCADE, -- 攻略情報番号
  created_at timestamptz NOT NULL DEFAULT now(),                                      -- いいね日時
  CONSTRAINT unique_user_strategy_like UNIQUE (user_id, strategy_no)
);

CREATE INDEX idx_mw_likes_strategy_no ON mw_likes (strategy_no);

ALTER TABLE mw_likes ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Likes are viewable by everyone" ON mw_likes FOR SELECT USING (true);
CREATE POLICY "Users can insert their own likes" ON mw_likes FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can delete their own likes" ON mw_likes FOR DELETE USING (auth.uid() = user_id);
```

---

### 10. public.mw_favorites_strategies (トランザクションテーブル)

**用途**: 攻略情報のお気に入りを保存。

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| favorite_strategy_no | bigint | PK, GENERATED ALWAYS AS IDENTITY | お気に入り攻略情報番号 |
| user_id | uuid | NOT NULL, FK → auth.users(id) ON DELETE CASCADE | ユーザーID |
| strategy_no | bigint | NOT NULL, FK → mw_strategies(strategy_no) ON DELETE CASCADE | 攻略情報番号 |
| sort_order | int | NOT NULL, DEFAULT 0 | 表示順 |
| created_at | timestamptz | NOT NULL, DEFAULT now() | 登録日時 |

**RLS**:
- SELECT: 自分のお気に入りのみ参照可
- INSERT: 認証済みユーザーが自分のuser_idでのみ登録可
- UPDATE: 自分のお気に入りのみ更新可（順序変更）
- DELETE: 自分のお気に入りのみ削除可

**DDL**:
```sql
CREATE TABLE mw_favorites_strategies (
  favorite_strategy_no bigint PRIMARY KEY GENERATED ALWAYS AS IDENTITY,               -- お気に入り攻略情報番号
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,                  -- ユーザーID
  strategy_no bigint NOT NULL REFERENCES mw_strategies(strategy_no) ON DELETE CASCADE, -- 攻略情報番号
  sort_order int NOT NULL DEFAULT 0,                                                  -- 表示順
  created_at timestamptz NOT NULL DEFAULT now(),                                      -- 登録日時
  CONSTRAINT unique_user_strategy_favorite UNIQUE (user_id, strategy_no)
);

CREATE INDEX idx_mw_favorites_strategies_user_id ON mw_favorites_strategies (user_id, sort_order);

ALTER TABLE mw_favorites_strategies ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view their own favorites" ON mw_favorites_strategies FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert their own favorites" ON mw_favorites_strategies FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update their own favorites" ON mw_favorites_strategies FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete their own favorites" ON mw_favorites_strategies FOR DELETE USING (auth.uid() = user_id);
```

---

### 11. public.mw_favorites_searches (トランザクションテーブル)

**用途**: 検索条件のお気に入りを保存。

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| favorite_search_no | bigint | PK, GENERATED ALWAYS AS IDENTITY | お気に入り検索条件番号 |
| user_id | uuid | NOT NULL, FK → auth.users(id) ON DELETE CASCADE | ユーザーID |
| monster_no | bigint | NULL, FK → mw_mst_monsters(monster_no) | モンスター番号（検索条件） |
| weapon_no | bigint | NULL, FK → mw_mst_weapons(weapon_no) | 武器番号（検索条件） |
| display_name | varchar(100) | NOT NULL | 表示名 |
| sort_order | int | NOT NULL, DEFAULT 0 | 表示順 |
| created_at | timestamptz | NOT NULL, DEFAULT now() | 登録日時 |

**RLS**:
- SELECT: 自分のお気に入りのみ参照可
- INSERT: 認証済みユーザーが自分のuser_idでのみ登録可
- UPDATE: 自分のお気に入りのみ更新可
- DELETE: 自分のお気に入りのみ削除可

**DDL**:
```sql
CREATE TABLE mw_favorites_searches (
  favorite_search_no bigint PRIMARY KEY GENERATED ALWAYS AS IDENTITY,        -- お気に入り検索条件番号
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,         -- ユーザーID
  monster_no bigint NULL REFERENCES mw_mst_monsters(monster_no),             -- モンスター番号（検索条件）
  weapon_no bigint NULL REFERENCES mw_mst_weapons(weapon_no),                -- 武器番号（検索条件）
  display_name varchar(100) NOT NULL,                                        -- 表示名
  sort_order int NOT NULL DEFAULT 0,                                         -- 表示順
  created_at timestamptz NOT NULL DEFAULT now()                              -- 登録日時
);

CREATE INDEX idx_mw_favorites_searches_user_id ON mw_favorites_searches (user_id, sort_order);

ALTER TABLE mw_favorites_searches ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view their own search favorites" ON mw_favorites_searches FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert their own search favorites" ON mw_favorites_searches FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update their own search favorites" ON mw_favorites_searches FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete their own search favorites" ON mw_favorites_searches FOR DELETE USING (auth.uid() = user_id);
```

---

### 12. public.mw_reports (トランザクションテーブル)

**用途**: 通報情報を保存。

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| report_no | bigint | PK, GENERATED ALWAYS AS IDENTITY | 通報番号 |
| reporter_user_id | uuid | NOT NULL, FK → auth.users(id) ON DELETE CASCADE | 通報者ユーザーID |
| strategy_no | bigint | NOT NULL, FK → mw_strategies(strategy_no) ON DELETE CASCADE | 通報対象攻略情報番号 |
| created_at | timestamptz | NOT NULL, DEFAULT now() | 通報日時 |

**RLS**:
- SELECT: 自分の通報のみ参照可
- INSERT: 認証済みユーザーが自分のreporter_user_idでのみ登録可
- UPDATE: 不可
- DELETE: 不可

**DDL**:
```sql
CREATE TABLE mw_reports (
  report_no bigint PRIMARY KEY GENERATED ALWAYS AS IDENTITY,                              -- 通報番号
  reporter_user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,             -- 通報者ユーザーID
  strategy_no bigint NOT NULL REFERENCES mw_strategies(strategy_no) ON DELETE CASCADE,    -- 通報対象攻略情報番号
  created_at timestamptz NOT NULL DEFAULT now(),                                          -- 通報日時
  CONSTRAINT unique_reporter_strategy UNIQUE (reporter_user_id, strategy_no)
);

CREATE INDEX idx_mw_reports_strategy_no ON mw_reports (strategy_no);

ALTER TABLE mw_reports ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view their own reports" ON mw_reports FOR SELECT USING (auth.uid() = reporter_user_id);
CREATE POLICY "Users can insert their own reports" ON mw_reports FOR INSERT WITH CHECK (auth.uid() = reporter_user_id);
```

---

### 13. public.mw_requests (トランザクションテーブル)

**用途**: マスタデータの追加・修正要望を保存。

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| request_no | bigint | PK, GENERATED ALWAYS AS IDENTITY | 要望番号 |
| user_id | uuid | NOT NULL, FK → auth.users(id) ON DELETE CASCADE | 送信者ユーザーID |
| request_category | request_category_enum | NOT NULL | 要望カテゴリー |
| request_content | text | NOT NULL | 要望内容（最大500文字） |
| request_status | request_status_enum | NOT NULL, DEFAULT 'pending' | 対応状況 |
| admin_comment | text | NULL | 運営者からの回答コメント |
| created_at | timestamptz | NOT NULL, DEFAULT now() | 送信日時 |
| updated_at | timestamptz | NOT NULL, DEFAULT now() | 更新日時 |

**要望カテゴリー**:
- `monster`: モンスターマスタ（モンスターの追加・修正要望）
- `weapon`: 武器マスタ（武器の追加・修正要望）
- `job`: 職業マスタ（職業の追加・修正要望）
- `bug`: 不具合報告（アプリの不具合報告）
- `feature`: 機能要望（新機能や改善の要望）
- `question`: 質問（使い方などの質問）
- `other`: その他（上記に該当しない要望）

**対応状況**:
- `pending`: 未対応
- `in_progress`: 対応中
- `completed`: 対応完了
- `rejected`: 対応不可

**RLS**:
- SELECT: 全員許可
- INSERT: 認証済みユーザーが自分のuser_idでのみ登録可
- UPDATE: 不可（運営者のみ管理アプリから更新）
- DELETE: 不可

**DDL**:
```sql
CREATE TYPE request_category_enum AS ENUM ('monster', 'weapon', 'job', 'bug', 'feature', 'question', 'other');
CREATE TYPE request_status_enum AS ENUM ('pending', 'in_progress', 'completed', 'rejected');

CREATE TABLE mw_requests (
  request_no bigint PRIMARY KEY GENERATED ALWAYS AS IDENTITY,            -- 要望番号
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,     -- 送信者ユーザーID
  request_category request_category_enum NOT NULL,                       -- 要望カテゴリー
  request_content text NOT NULL,                                         -- 要望内容
  request_status request_status_enum NOT NULL DEFAULT 'pending',         -- 対応状況
  admin_comment text NULL,                                               -- 運営者からの回答コメント
  created_at timestamptz NOT NULL DEFAULT now(),                         -- 送信日時
  updated_at timestamptz NOT NULL DEFAULT now(),                         -- 更新日時
  CONSTRAINT check_request_content_length CHECK (char_length(request_content) <= 500)
);

CREATE INDEX idx_mw_requests_user_id ON mw_requests (user_id);
CREATE INDEX idx_mw_requests_category ON mw_requests (request_category);
CREATE INDEX idx_mw_requests_status ON mw_requests (request_status);
CREATE INDEX idx_mw_requests_created_at ON mw_requests (created_at DESC);

ALTER TABLE mw_requests ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Requests are viewable by everyone" ON mw_requests FOR SELECT USING (true);
CREATE POLICY "Users can insert their own requests" ON mw_requests FOR INSERT WITH CHECK (auth.uid() = user_id);
```

---

## DDL実行順序

Supabaseプロジェクトでデータベースをセットアップする際は、以下の順序でSQLを実行してください。

1. profiles テーブル
2. ng_words テーブル
3. monster_category_enum 型（ENUM）
4. mw_mst_monsters テーブル
5. mw_mst_weapons テーブル
6. job_rank_enum 型（ENUM）
7. mw_mst_jobs テーブル
8. strategy_type_enum 型（ENUM）
9. mw_strategies テーブル
10. mw_strategy_members テーブル
11. mw_likes テーブル
12. mw_favorites_strategies テーブル
13. mw_favorites_searches テーブル
14. mw_reports テーブル
15. request_category_enum 型（ENUM）
16. request_status_enum 型（ENUM）
17. mw_requests テーブル

※外部キー制約・型の依存関係により、この順序で実行する必要があります。

---

## ERD（Entity Relationship Diagram）

```mermaid
erDiagram
    users ||--o| profiles : "has"
    users ||--o{ mw_strategies : "registers"
    users ||--o{ mw_likes : "likes"
    users ||--o{ mw_favorites_strategies : "favorites"
    users ||--o{ mw_favorites_searches : "favorites"
    users ||--o{ mw_reports : "reports"
    users ||--o{ mw_requests : "requests"

    mw_mst_monsters ||--o{ mw_strategies : "target"
    mw_mst_monsters ||--o{ mw_favorites_searches : "search_condition"
    mw_mst_weapons ||--o{ mw_strategy_members : "uses"
    mw_mst_weapons ||--o{ mw_favorites_searches : "search_condition"
    mw_mst_jobs ||--o{ mw_strategy_members : "uses"

    mw_strategies ||--o{ mw_strategy_members : "has"
    mw_strategies ||--o{ mw_likes : "receives"
    mw_strategies ||--o{ mw_favorites_strategies : "is_favorited"
    mw_strategies ||--o{ mw_reports : "is_reported"

    users {
        uuid id PK
        varchar email UK
        varchar encrypted_password
        timestamptz created_at
    }

    profiles {
        uuid user_id PK_FK
        varchar nickname
        text avatar_url
        boolean x_account_public
        timestamptz created_at
        timestamptz updated_at
    }

    ng_words {
        bigint ng_word_no PK
        varchar word UK
        timestamptz created_at
    }

    mw_mst_monsters {
        bigint monster_no PK
        monster_category_enum monster_category
        varchar monster_name UK
        int star_rank
        date release_date
        int sort_order
        boolean is_active
    }

    mw_mst_weapons {
        bigint weapon_no PK
        varchar weapon_name UK
        int star_rank
        date release_date
        int sort_order
        boolean is_active
    }

    mw_mst_jobs {
        bigint job_no PK
        varchar job_name UK
        job_rank_enum job_rank
        int sort_order
        boolean is_active
    }

    mw_strategies {
        bigint strategy_no PK
        uuid user_id FK
        bigint monster_no FK
        varchar strategy_type
        text action_description "NULL=未入力"
        int like_count
        boolean is_deleted
        timestamptz created_at
    }

    mw_strategy_members {
        bigint member_no PK
        bigint strategy_no FK
        int member_order
        bigint weapon_no FK "NULL=任意"
        bigint job_no FK "NULL=任意"
        text screenshot_front_url "NULL=未登録"
        text screenshot_back_url "NULL=未登録"
    }

    mw_likes {
        bigint like_no PK
        uuid user_id FK
        bigint strategy_no FK
        timestamptz created_at
    }

    mw_favorites_strategies {
        bigint favorite_strategy_no PK
        uuid user_id FK
        bigint strategy_no FK
        int sort_order
    }

    mw_favorites_searches {
        bigint favorite_search_no PK
        uuid user_id FK
        bigint monster_no FK
        bigint weapon_no FK
        varchar display_name
        int sort_order
    }

    mw_reports {
        bigint report_no PK
        uuid reporter_user_id FK
        bigint strategy_no FK
        timestamptz created_at
    }

    mw_requests {
        bigint request_no PK
        uuid user_id FK
        request_category_enum request_category
        text request_content
        request_status_enum request_status
        text admin_comment
        timestamptz created_at
        timestamptz updated_at
    }
```

---

## Row Level Security (RLS) ポリシー

### 基本方針
MonsterWalkerでは、**読み取りは基本的に全員に公開**（お気に入り・通報は自分のデータのみ）、**書き込み・削除は認証済みユーザーが自分のデータのみ操作可能**というセキュリティ設計を採用しています。

### RLSポリシー一覧

| テーブル | SELECT | INSERT | UPDATE | DELETE |
|---------|--------|--------|--------|--------|
| profiles | 全員 | 自分のみ | 自分のみ | 不可 |
| ng_words | 全員 | 不可 | 不可 | 不可 |
| mw_mst_* | 全員 | 不可 | 不可 | 不可 |
| mw_strategies | 全員 | 自分のみ | 自分のみ | 自分のみ |
| mw_strategy_members | 全員 | 自分のみ | 自分のみ | 自分のみ |
| mw_likes | 全員 | 自分のみ | 不可 | 自分のみ |
| mw_favorites_strategies | 自分のみ | 自分のみ | 自分のみ | 自分のみ |
| mw_favorites_searches | 自分のみ | 自分のみ | 自分のみ | 自分のみ |
| mw_reports | 自分のみ | 自分のみ | 不可 | 不可 |
| mw_requests | 全員 | 自分のみ | 不可 | 不可 |

---

## パフォーマンス考慮事項

### インデックス戦略
1. **いいね数ソート** (`idx_mw_strategies_like_count`)
   - 検索結果のいいね数順ソートに使用
   - DESC順でインデックス作成

2. **モンスター検索** (`idx_mw_strategies_monster_no`)
   - モンスター別の攻略情報検索に使用

3. **ユーザー別表示** (`idx_mw_strategies_user_id`)
   - マイページでの自分の攻略情報一覧に使用

4. **削除フラグ** (`idx_mw_strategies_is_deleted`)
   - 論理削除されていない攻略情報のみ取得

### クエリ最適化
- **is_deletedフィルタ**: RLSポリシーで自動適用
- **ページネーション**: LIMIT/OFFSETで効率的なデータ取得
- **like_countキャッシュ**: 集計クエリを避けるためにキャッシュ値を保持

### スケーラビリティ
- **想定レコード数**: 1,000ユーザー × 平均10攻略情報 = 約10,000レコード
- **Supabase無料プラン**: 500MBまで対応可能（十分な余裕）

---

## Supabase Storage設計

### バケット構成

| バケット名 | 用途 | 公開設定 | 備考 |
|-----------|------|----------|------|
| avatars | ユーザーアイコン画像 | public | 共用（他アプリと共有） |
| mw_screenshots | 攻略情報のスクリーンショット | public | 本アプリ専用 |

### ファイルパス規則

**avatars（ユーザーアイコン）:**
```
avatars/{user_id}/avatar.{ext}
```
- 例: `avatars/550e8400-e29b-41d4-a716-446655440000/avatar.png`

**mw_screenshots（攻略スクリーンショット）:**
```
mw_screenshots/{user_id}/{strategy_no}/{member_order}_{front|back}.{ext}
```
- 例: `mw_screenshots/550e8400-e29b-41d4-a716-446655440000/123/1_front.png`
- 例: `mw_screenshots/550e8400-e29b-41d4-a716-446655440000/123/1_back.png`

### ファイル制限

| 項目 | 制限値 |
|------|--------|
| 最大ファイルサイズ | 5MB |
| 許可拡張子 | jpg, jpeg, png, webp |
| 許可MIMEタイプ | image/jpeg, image/png, image/webp |

### RLSポリシー

**avatars:**
| 操作 | ポリシー |
|------|----------|
| SELECT | 全員許可（公開画像） |
| INSERT | 認証済みユーザーのみ、自分のフォルダのみ |
| UPDATE | 認証済みユーザーのみ、自分のフォルダのみ |
| DELETE | 認証済みユーザーのみ、自分のフォルダのみ |

**mw_screenshots:**
| 操作 | ポリシー |
|------|----------|
| SELECT | 全員許可（公開画像） |
| INSERT | 認証済みユーザーのみ、自分のフォルダのみ |
| UPDATE | 認証済みユーザーのみ、自分のフォルダのみ |
| DELETE | 認証済みユーザーのみ、自分のフォルダのみ |

### バケット作成SQL

```sql
-- avatarsバケット作成（共用・既存の場合はスキップ）
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
  'avatars',
  'avatars',
  true,
  5242880,  -- 5MB
  ARRAY['image/jpeg', 'image/png', 'image/webp']
)
ON CONFLICT (id) DO NOTHING;

-- mw_screenshotsバケット作成
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
  'mw_screenshots',
  'mw_screenshots',
  true,
  5242880,  -- 5MB
  ARRAY['image/jpeg', 'image/png', 'image/webp']
)
ON CONFLICT (id) DO NOTHING;
```

### Storage RLSポリシーSQL

```sql
-- avatarsバケットのRLSポリシー
-- SELECT: 全員許可
CREATE POLICY "avatars_select_policy" ON storage.objects
  FOR SELECT USING (bucket_id = 'avatars');

-- INSERT: 自分のフォルダのみ
CREATE POLICY "avatars_insert_policy" ON storage.objects
  FOR INSERT WITH CHECK (
    bucket_id = 'avatars'
    AND auth.uid()::text = (storage.foldername(name))[1]
  );

-- UPDATE: 自分のフォルダのみ
CREATE POLICY "avatars_update_policy" ON storage.objects
  FOR UPDATE USING (
    bucket_id = 'avatars'
    AND auth.uid()::text = (storage.foldername(name))[1]
  );

-- DELETE: 自分のフォルダのみ
CREATE POLICY "avatars_delete_policy" ON storage.objects
  FOR DELETE USING (
    bucket_id = 'avatars'
    AND auth.uid()::text = (storage.foldername(name))[1]
  );

-- mw_screenshotsバケットのRLSポリシー
-- SELECT: 全員許可
CREATE POLICY "mw_screenshots_select_policy" ON storage.objects
  FOR SELECT USING (bucket_id = 'mw_screenshots');

-- INSERT: 自分のフォルダのみ
CREATE POLICY "mw_screenshots_insert_policy" ON storage.objects
  FOR INSERT WITH CHECK (
    bucket_id = 'mw_screenshots'
    AND auth.uid()::text = (storage.foldername(name))[1]
  );

-- UPDATE: 自分のフォルダのみ
CREATE POLICY "mw_screenshots_update_policy" ON storage.objects
  FOR UPDATE USING (
    bucket_id = 'mw_screenshots'
    AND auth.uid()::text = (storage.foldername(name))[1]
  );

-- DELETE: 自分のフォルダのみ
CREATE POLICY "mw_screenshots_delete_policy" ON storage.objects
  FOR DELETE USING (
    bucket_id = 'mw_screenshots'
    AND auth.uid()::text = (storage.foldername(name))[1]
  );
```

---

## まとめ

MonsterWalkerのデータベース設計は以下の特徴があります：

- **dqwfuntool共用設計**: users, profiles, ng_wordsは他アプリと共用
- **命名規則**: 本アプリ専用テーブルは`mw_`プレフィクス、マスタは`mw_mst_`プレフィクス
- **RLSによるセキュリティ**: データベースレベルでのアクセス制御
- **適切なインデックス**: 検索・ソートのパフォーマンス確保
- **スケーラブル**: 1,000ユーザー規模に十分対応可能
- **コスト効率**: Supabase無料プランで運用可能
